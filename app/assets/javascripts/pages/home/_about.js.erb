/* global $ */
/* global sectionInitialize */
/* global responsiveEvents */
/* global cardEvents */
/* global contactEvents */

$( document ).on('turbolinks:load', function() {
  var about = 'section#about';
    var container = about + ' div#about-container';
      var card = container + ' div#about-cards .card';
          var tondo = card + ' div.about-card-tondo';
          var contact = card + ' .btn-contact';
      var breadcrumbs = container + ' div#about-breadcrumbs';
        var breadcrumb = breadcrumbs + ' div';
  
  var $about = $(about);
    var $container = $(container);
      var $card = $(card);
        var $tondo = $(tondo);
        var $contact = $(contact);
      var $breadcrumb = $(breadcrumb);
  
  // Dramatic intro for first card
  (function() {
    var timeout = window.setTimeout(function() {
      $card.first().addClass('focus');
      
      window.clearTimeout(timeout);
    }, 500);
  }());
  
  // Throw breadcrumbs out
  (function() {
    var timeout = window.setTimeout(function() {
      $breadcrumb.each(function(i) {
        $(this).css({
          left: (100 * (i + 1) / ($breadcrumb.length + 1)) + '%',
        });
      });
      
      window.clearTimeout(timeout);
    }, 1500);
  }());
  
  $breadcrumb.first().addClass('active');
  
  var pxBuffer = 100;
  
  sectionInitialize($about, $container, pxBuffer);
  
  var sizeTondo = function($thisTondo) {
    var cardHeight = $card.height();
    var cardWidth =  $card.width();
    var pixelGutter = 15;
    var tondoRatio = 0.4;
    var pixelOffsetTop;
    var pixelOffsetLeft;
    var tondoSide =  (cardHeight > cardWidth ? cardWidth : cardHeight);
    
    if ($thisTondo.hasClass('focus')) {
      tondoSide -= pixelGutter * 2;
      pixelOffsetTop = cardHeight / 2;
      pixelOffsetLeft = cardWidth / 2;
    } else {
      tondoSide *= tondoRatio;
      tondoSide -= pixelGutter * 2;
      pixelOffsetTop = tondoSide / 2 + pixelGutter;
      pixelOffsetLeft = tondoSide / 2 + pixelGutter;
    }
    
    $thisTondo.css({
      height: tondoSide,
      width: tondoSide,
      top: pixelOffsetTop,
      left: pixelOffsetLeft,
    });
  };
  
  var sizeAllTondos = function() {
    $tondo.each(function(i) {
      sizeTondo($(this));
    });
  };
  
  sizeAllTondos();
  
  $( window ).resize(function() {
    var timeout = window.setTimeout(function() {
      sizeAllTondos();
      window.clearTimeout(timeout);
    }, 1100);
  });
  
  var updateContent = function() {
    $(this).removeClass('mousedown hover');
    
    if (!$(this).hasClass('active')) {
      indexCards($(this).index());
      $breadcrumb.removeClass('active');
      $(this).addClass('active');
    }
  };
  
  var indexCards = cardEvents($card, function(newCardIndex) {
    $breadcrumb.removeClass('active');
    
    $breadcrumb.eq(newCardIndex).addClass('active');
  });
  
  // Disable the first card focus for dramatic intro
  $card.first().removeClass('focus');
  
  contactEvents($contact, 3000, function() {
    if ($( window ).scrollTop() < pxBuffer) {
      $( window ).scrollTop(pxBuffer);
    }
  });
  
  responsiveEvents($breadcrumb, updateContent);
  
  responsiveEvents($tondo, function(e) {
    e.preventDefault();
    $(this).toggleClass('focus');
    sizeTondo($(this));
  });
});
